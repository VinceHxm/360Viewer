<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Safari Sidebar 测试</title>
    <style>
        :root {
          --bg: #0f1115;
          --fg: #e6e6e6;
          --muted: #9aa4b2;
          --brand: #4f8cff;
          --panel: #161922;
          --btn: #1e2430;
          --btn-hover: #2a3142;
        }
        
        * { box-sizing: border-box; }
        html, body { 
          height: 100%; 
          margin: 0; 
          padding: 0; 
          overflow-x: hidden;
        }
        body {
          background: var(--bg);
          color: var(--fg);
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .app-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 10px 14px;
          background: var(--panel);
          border-bottom: 1px solid #202636;
        }
        
        .brand { font-weight: 700; color: var(--brand); }
        
        .viewer {
          position: relative;
          height: calc(100vh - 60px);
          min-height: 360px;
          outline: none;
          /* Safari浏览器特殊优化 */
          -webkit-overflow-scrolling: touch;
          -webkit-transform: translateZ(0);
          transform: translateZ(0);
          will-change: transform;
        }
        
        .sidebar {
          position: absolute;
          right: 0;
          top: 0;
          bottom: 0;
          width: clamp(220px, 28vw, 360px);
          background: var(--panel);
          border-left: 1px solid #202636;
          display: flex;
          flex-direction: column;
          z-index: 100;
          /* Safari浏览器特殊优化 */
          -webkit-transform: translateZ(0);
          transform: translateZ(0);
          -webkit-backface-visibility: hidden;
          backface-visibility: hidden;
        }
        
        .sidebar__header { 
          display: flex; 
          gap: 8px; 
          padding: 8px; 
          border-bottom: 1px solid #202636; 
        }
        
        .tabs { 
          display: flex; 
          gap: 6px; 
          padding: 8px; 
          border-bottom: 1px solid #202636; 
        }
        
        .tab { 
          background: var(--btn); 
          color: var(--fg); 
          border: 1px solid #2a3142; 
          padding: 6px 10px; 
          border-radius: 6px; 
          cursor: pointer; 
        }
        
        .tab.active { background: var(--btn-hover); }
        
        .tabpanes { flex: 1; overflow: auto; }
        
        .file-list { 
          list-style: none; 
          margin: 0; 
          padding: 0; 
        }
        
        .file-list li { 
          padding: 8px 10px; 
          border-bottom: 1px solid #202636; 
          cursor: default; 
          display: flex; 
          justify-content: space-between; 
          gap: 8px; 
        }
        
        .file-list li:hover { background: #1a1f2b; }
        
        .file-list__name { 
          overflow: hidden; 
          text-overflow: ellipsis; 
          white-space: nowrap; 
        }
        
        .main-content {
          position: absolute;
          left: 0;
          top: 0;
          right: clamp(220px, 28vw, 360px);
          bottom: 0;
          background: var(--bg);
          display: flex;
          align-items: center;
          justify-content: center;
          flex-direction: column;
          padding: 20px;
        }
        
        .device-info {
          position: fixed;
          top: 10px;
          left: 10px;
          background: rgba(0,0,0,0.8);
          padding: 10px;
          border-radius: 5px;
          font-size: 12px;
          z-index: 1000;
          max-width: 300px;
        }
        
        .test-button {
          background: var(--brand);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 5px;
          cursor: pointer;
          margin: 10px;
        }
        
        .test-button:hover {
          background: #5a9cff;
        }
        
        /* Safari浏览器特殊样式（包括iOS和macOS） */
        @supports (-webkit-touch-callout: none) {
          .sidebar {
            /* iOS设备sidebar特殊优化 */
            position: absolute !important;
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
          }
        }
        
        /* macOS Safari特殊样式 */
        @supports (-webkit-appearance: none) {
          .sidebar {
            /* macOS Safari sidebar优化 */
            position: absolute !important;
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 100 !important;
          }
        }
        
        @media (max-width: 768px) {
          .sidebar {
            width: clamp(200px, 35vw, 300px);
            z-index: 100;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
          }
          
          .main-content {
            right: clamp(200px, 35vw, 300px);
          }
        }
    </style>
</head>
<body>
    <div class="device-info" id="deviceInfo">
        设备检测中...
    </div>
    
    <header class="app-header">
        <div class="brand">Safari Sidebar 测试</div>
    </header>
    
    <main class="viewer">
        <div class="main-content">
            <h2>🎯 Safari浏览器右侧边栏测试</h2>
            <p>如果您看到右侧边栏，说明修复成功！</p>
            <p>如果看不到，请检查控制台日志。</p>
            
            <button class="test-button" onclick="testSidebar()">测试Sidebar</button>
            <button class="test-button" onclick="forceShowSidebar()">强制显示Sidebar</button>
            <button class="test-button" onclick="checkSidebarStatus()">检查状态</button>
        </div>
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar__header">
                <span>📱 右侧边栏</span>
            </div>
            <div class="tabs">
                <button class="tab active">视频</button>
                <button class="tab">图片</button>
            </div>
            <div class="tabpanes">
                <ul class="file-list">
                    <li><span class="file-list__name">测试视频 1</span></li>
                    <li><span class="file-list__name">测试视频 2</span></li>
                    <li><span class="file-list__name">测试视频 3</span></li>
                    <li><span class="file-list__name">测试视频 4</span></li>
                    <li><span class="file-list__name">测试视频 5</span></li>
                    <li><span class="file-list__name">测试视频 6</span></li>
                    <li><span class="file-list__name">测试视频 7</span></li>
                    <li><span class="file-list__name">测试视频 8</span></li>
                    <li><span class="file-list__name">测试视频 9</span></li>
                    <li><span class="file-list__name">测试视频 10</span></li>
                </ul>
            </div>
        </aside>
    </main>

    <script>
        // 设备检测
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isSafari = /Safari/i.test(navigator.userAgent) && !/Chrome|CriOS|FxiOS/i.test(navigator.userAgent);
        const isMacOSSafari = isSafari && /Macintosh/i.test(navigator.userAgent);
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        document.getElementById('deviceInfo').innerHTML = `
            <strong>设备检测结果：</strong><br>
            设备: ${isMobile ? '移动端' : '桌面端'}<br>
            iOS: ${isIOS ? '是' : '否'}<br>
            Safari: ${isSafari ? '是' : '否'}<br>
            macOS Safari: ${isMacOSSafari ? '是' : '否'}<br>
            <br>
            <strong>User Agent:</strong><br>
            ${navigator.userAgent.substring(0, 80)}...
        `;
        
        console.log('设备检测:', { isMobile, isIOS, isSafari, isMacOSSafari, userAgent: navigator.userAgent });
        
        // Safari浏览器特殊处理
        function initSafariOptimizations() {
            console.log('初始化Safari浏览器优化');
            
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                // 确保sidebar可见
                sidebar.style.display = 'flex';
                sidebar.style.visibility = 'visible';
                sidebar.style.opacity = '1';
                sidebar.style.position = 'absolute';
                sidebar.style.right = '0';
                sidebar.style.top = '0';
                sidebar.style.bottom = '0';
                sidebar.style.zIndex = '100';
                
                // 强制重绘
                sidebar.style.transform = 'translateZ(0)';
                sidebar.style.webkitTransform = 'translateZ(0)';
                
                console.log('Sidebar样式已应用:', {
                    display: sidebar.style.display,
                    visibility: sidebar.style.visibility,
                    opacity: sidebar.style.opacity,
                    position: sidebar.style.position,
                    width: sidebar.offsetWidth,
                    height: sidebar.offsetHeight
                });
            }
            
            // 延迟检查
            setTimeout(() => {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    console.log('延迟检查 - Sidebar尺寸:', {
                        offsetWidth: sidebar.offsetWidth,
                        offsetHeight: sidebar.offsetHeight,
                        clientWidth: sidebar.clientWidth,
                        clientHeight: sidebar.clientHeight
                    });
                    
                    if (sidebar.offsetWidth === 0) {
                        console.warn('Sidebar不可见，尝试修复');
                        sidebar.style.width = '250px';
                        sidebar.style.minWidth = '200px';
                    }
                }
            }, 100);
        }
        
        // 测试函数
        function testSidebar() {
            const sidebar = document.getElementById('sidebar');
            console.log('Sidebar测试:', {
                element: sidebar,
                display: sidebar.style.display,
                visibility: sidebar.style.visibility,
                opacity: sidebar.style.opacity,
                position: sidebar.style.position,
                offsetWidth: sidebar.offsetWidth,
                offsetHeight: sidebar.offsetHeight,
                clientWidth: sidebar.clientWidth,
                clientHeight: sidebar.clientHeight
            });
        }
        
        function forceShowSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.style.display = 'flex';
            sidebar.style.visibility = 'visible';
            sidebar.style.opacity = '1';
            sidebar.style.position = 'absolute';
            sidebar.style.right = '0';
            sidebar.style.top = '0';
            sidebar.style.bottom = '0';
            sidebar.style.zIndex = '100';
            sidebar.style.width = '250px';
            console.log('强制显示Sidebar');
        }
        
        function checkSidebarStatus() {
            const sidebar = document.getElementById('sidebar');
            const rect = sidebar.getBoundingClientRect();
            console.log('Sidebar状态检查:', {
                rect: rect,
                computedStyle: window.getComputedStyle(sidebar),
                isVisible: rect.width > 0 && rect.height > 0
            });
        }
        
        // 初始化
        if (isIOS || isSafari) {
            initSafariOptimizations();
        }
        
        // 窗口大小变化监听
        window.addEventListener('resize', () => {
            setTimeout(() => {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    console.log('Resize后 - Sidebar尺寸:', {
                        offsetWidth: sidebar.offsetWidth,
                        offsetHeight: sidebar.offsetHeight
                    });
                }
            }, 100);
        });
    </script>
</body>
</html>
