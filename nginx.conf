server {
    listen       80;
    server_name  localhost;

    # 将此路径替换为你的部署目录
    root   /usr/share/nginx/html/360Video;
    index  index.html;

    # 全局CORS设置
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
    add_header Access-Control-Allow-Headers "*" always;

    # 处理OPTIONS预检请求
    location / {
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
            add_header Access-Control-Allow-Headers "*";
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain charset=UTF-8';
            add_header Content-Length 0;
            return 204;
        }
        try_files $uri $uri/ /index.html;
    }

    # 优先匹配并返回静态资源，避免被 SPA 回退吞掉
    location ~* \.(?:js|css|map|png|jpe?g|gif|webp|svg|ico|mp4|webm|ogv|ogg|m3u8|ts)$ {
        try_files $uri =404;
        access_log off;
        # 减少缓存时间，便于调试
        add_header Cache-Control "public, max-age=300";
    }

    # 服务器媒体资源目录，例如挂载到 /usr/share/nginx/html/media
    location /media/ {
        alias /usr/share/nginx/html/media/;  # 使用alias而不是root
        autoindex on; # 若不希望列目录，可改为 off，并提供 manifest.json
        autoindex_exact_size off;  # 显示文件大小
        autoindex_localtime on;     # 显示本地时间
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "*" always;
        
        # 确保媒体文件能正确访问
        location ~* \.(mp4|webm|ogv|ogg|mov|m3u8|jpg|jpeg|png|webp|gif|bmp)$ {
            expires 1d;
            add_header Cache-Control "public, no-transform";
        }
        
        # 如需缓存可打开：
        # add_header Cache-Control "public, max-age=86400";
    }

    # 缓存与类型设置（可按需调整）
    location ~* \.(?:js|css)$ {
        # 减少缓存时间，便于调试
        add_header Cache-Control "public, max-age=300";
    }

    # 常见媒体类型
    types {
        text/html                             html htm shtml;
        text/css                              css;
        application/javascript                js mjs;
        application/wasm                      wasm;
        image/jpeg                            jpeg jpg;
        image/png                             png;
        image/gif                             gif;
        image/webp                            webp;
        image/svg+xml                         svg svgz;
        video/mp4                             mp4;
        video/webm                            webm;
        video/ogg                             ogv;
        audio/mpeg                            mp3;
        application/octet-stream              bin exe dll;
        application/json                      json;
    }

    gzip on;
    gzip_types text/plain text/css application/javascript application/json;
}


